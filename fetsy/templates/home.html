{% load i18n %}
{% load staticfiles %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" ng-app="FeTSy">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico">

    <title>FetSy</title>

    <!-- Libraries styles -->
    <link href="{% static 'css/fetsy-libs.css' %}" rel="stylesheet">

    <!-- Custom styles -->
    <link href="{% static 'css/fetsy.css' %}" rel="stylesheet">

    <!-- HTML5 Shiv and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="{% static 'js/html5shiv.js' %}"></script>
        <script src="{% static 'js/respond.src.js' %}"></script>
    <![endif]-->

    <!-- Libraries JS -->
    <script src="{% static 'js/fetsy-libs.js' %}"></script>

    <!-- Custom JS -->
    <script>
        var baseRestUrl = "{% url 'api-root' %}".replace(/\/$/,'');
    </script>
    <script src="{% static 'js/fetsy.js' %}"></script>

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="{% static 'js/ie10-viewport-bug-workaround.js' %}"></script>
</head>

<body>

    <!-- Top navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button"
                        class="navbar-toggle collapsed"
                        data-toggle="collapse"
                        data-target="#navbar"
                        aria-expanded="false"
                        aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="{% url 'home' %}">FetSy</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="{% url 'admin:index' %}">Administration</a></li>
                    <li><a href="{% url 'api-root' %}">REST API</a></li>
                    <li><a href="{% url 'logout' %}">Logout</a></li>
                </ul>
            </div><!-- /.nav-collapse -->
        </div>
    </nav>

{% verbatim %}

    <!-- Main container -->
    <div class="container">
        <div style="padding: 40px 15px;" ng-controller="TicketListCtrl as ticketCtrl">

            <!-- newTicketForm button and modal -->
            <div class="pull-left">
                <button type="button" class="btn btn-primary" ng-click="ticketCtrl.newTicketForm()">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    New Ticket
                </button>
                <script type="text/ng-template" id="newTicketForm.html">
                    <div class="modal-header">
                        <h3 class="modal-title">New ticket</h3>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="newTicketContent" class="sr-only">Content</label>
                            <textarea id="newTicketContent"
                                      class="form-control"
                                      rows="3"
                                      required
                                      ng-model="newTicketFormModalCtrl.content">
                            </textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" ng-click="newTicketFormModalCtrl.save()">Save</button>
                        <button class="btn btn-default" ng-click="newTicketFormModalCtrl.cancel()">Cancel</button>
                    </div>
                </script>
            </div>

            <!-- Search bar for filtering the table -->
            <div class="pull-right" style="padding-bottom:1em;">
                <label for="search" class="sr-only">Search</label>
                <div class="input-group">
                    <span id="searchIcon"
                          class="input-group-addon glyphicon glyphicon-search"
                          aria-hidden="true"></span>
                    <input id="search"
                           type="text"
                           class="form-control"
                           placeholder="Search"
                           aria-describedby="searchIcon"
                           ng-model="ticketCtrl.filter">
                    <span type="button"
                          class="input-group-addon btn"
                          ng-click="ticketCtrl.filter = ''">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                        <span class="sr-only">Reset search field</span>
                    </span>
                </div>
            </div>

            <!-- Main table -->
            <table class="table table-striped table-bordered">

                <!-- Table head with clickable sorting -->
                <thead>
                    <tr>
                        <th ng-repeat="header in ticketCtrl.headers" ng-click="ticketCtrl.toggleSort($index)">
                            <a>{{ header.verboseName }}</a>
                            <span class="dropup pull-right"
                                  ng-show="ticketCtrl.sortColumn === header.key && !ticketCtrl.reverse">
                                <span class="caret"></span>
                            </span>
                            <span class="pull-right"
                                  ng-show="ticketCtrl.sortColumn === header.key && ticketCtrl.reverse">
                                <span class="caret"></span>
                            </span>
                        </th>
                        <th></th>
                    </tr>
                </thead>

                <!-- Table body -->
                <tbody>
                    <tr ng-repeat="ticket in ticketCtrl.tickets | filter : ticketCtrl.filter | orderBy : ticketCtrl.sortColumn : ticketCtrl.reverse">

                        <!-- Ticket ID -->
                        <td>{{ ticket.id }}</td>

                        <!-- Ticket content, truncated, with tags and form to update the content -->
                        <td>

                            <!-- Ticket content and tags -->
                            <span ng-hide="ticket.editing">
                                {{ ticket.content | limitTo : ticketCtrl.limit }}
                                <span ng-show="ticket.isLong()">…</span>
                                <span ng-repeat="tag in ticket.tags"
                                      class="label label-{{ tag.color_css_class }}"
                                      style="margin-right:0.3em;">
                                      {{ tag.name }}
                                </span>
                                <span class="pull-right">
                                    <button type="button"
                                            class="btn btn-xs btn-default"
                                            ng-click="ticket.editing = true">
                                        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                        <span class="sr-only">Edit content</span>
                                    </button>
                                </span>
                            </span>

                            <!-- Ticket content update form-->
                            <form ng-show="ticket.editing"
                                  ng-submit="ticket.change({'content': ticket.tmpContent, 'tags': ticket.tmpTags});
                                             ticket.editing = false">
                                <div class="form-group">
                                    <label for="updateTicketTags" class="sr-only">Tags</label>
                                    <multiselect id="updateTicketTags"
                                                 ng-model="ticket.tmpTags"
                                                 options="ticketCtrl.allTags"
                                                 id-prop="name"
                                                 display-prop="name">
                                    </multiselect>
                                </div>
                                <div class="form-group">
                                    <label for="updateTicketContent" class="sr-only">Content</label>
                                    <textarea id="updateTicketContent"
                                              class="form-control"
                                              rows="3"
                                              required
                                              ng-model="ticket.tmpContent">
                                    </textarea>
                                </div>
                                <button type="submit"
                                        class="btn btn-primary">
                                    Save
                                </button>
                                <button type="button"
                                        class="btn btn-default"
                                        ng-click="ticket.tmpTags = ticket.tags;
                                                  ticket.tmpContent = ticket.content;
                                                  ticket.editing = false">
                                    Cancel
                                </button>
                            </form>

                        </td>

                        <!-- Ticket status with dropdown to change it -->
                        <td>
                            {{ ticket.status }}
                            <span class="dropdown pull-right">
                                <button id="dropdownStatus"
                                        type="button"
                                        class="btn btn-xs btn-default"
                                        data-toggle="dropdown"
                                        aria-expanded="true">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                    <span class="sr-only">Edit status</span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownStatus">
                                    <li ng-repeat="choice in ticketCtrl.options.actions.POST.status.choices">
                                        <a ng-click="ticket.change({'status': choice.value})">{{ choice.value }}</a>
                                    </li>
                                </ul>
                            </span>
                        </td>

                        <!-- Ticket assignee with dropdown to change it -->
                        <td>
                            {{ ticket.assignee.name }}
                            <span class="dropdown pull-right">
                                <button id="dropdownAssignee"
                                        type="button"
                                        class="btn btn-xs btn-default"
                                        data-toggle="dropdown"
                                        aria-expanded="true">
                                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                                    <span class="sr-only">Edit assignee</span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownAssignee">
                                    <li ng-repeat="user in ticketCtrl.allUsers">
                                        <a ng-click="ticket.change({'assignee': {'id': user.id, 'name': user.name}})">{{ user.name }}</a>
                                    </li>
                                </ul>
                            </span>
                        </td>

                        <!-- Info and delete buttons -->
                        <td>
                            <span class="pull-right">
                                <button type="button"
                                        class="btn btn-xs btn-success"
                                        ng-click="ticket.popOver($event)" >
                                    <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                                    <span class="sr-only">Get more info</span>
                                </button>
                                <button type="button"
                                        class="btn btn-xs btn-danger"
                                        ng-click="ticket.destroy()">
                                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                    <span class="sr-only">Remove ticket</span>
                                </button>
                            </span>
                        </td>

                    </tr>

                </tbody>

            </table><!-- / Main table -->

        </div>

        <hr>

        <footer>
            <p>&copy; 2015 <a href="http://rechtsanwalt-jaeckel.de">Norman Jäckel</a></p>
        </footer>

    </div><!-- / Main container -->

{% endverbatim %}

</body>

</html>
